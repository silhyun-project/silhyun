<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.yedam.silhyun.classes.map.ClassesMapper">

<!-- 수강중인 강의의 인강 목록  -->
<resultMap id="IVlist" type="java.util.HashMap">
  <result column="ttl" property="ttl"/>
  <result column="inetNum" property="inetNum"/>
  <result column="ittl" property="ittl"/>
  <result column="itime" property="itime"/>
  <result column="icount" property="icount"/>
  <result column="iVrate" property="iVrate"/>
  <result column="i_state" property="iState"/>
   <result column="i_state_100" property="iBack"/>
</resultMap>

<select id="getClassIVInfo" resultMap="IVlist">
SELECT 
    c.cla_ttl as ttl, 
    i.inet_num as inetNum, 
    i.inet_ttl as ittl, 
    i.inet_time as itime, 
    (SELECT COUNT(*) FROM inetclass WHERE class_num = '2') AS icount,
    nvl(ROUND((w.ew_time/(i.inet_time*60)), 3) * 100,0) AS "iVrate",
    nvl(ROUND((w.cumlw_time/(i.inet_time*60)), 3) * 100,0) AS "i_state",
    (SELECT COUNT(*) FROM inetclass_wtch w2 JOIN inetclass i2 ON i2.class_num = 
    w2.class_num AND i2.inet_num = w2.inet_num WHERE w2.id = 'catLove' 
    AND w2.class_num = '2' AND ROUND((w2.cumlw_time/(i2.inet_time*60)), 3) * 100 = 100) 
    AS "i_state_100"
FROM 
    inetclass i
    LEFT JOIN inetclass_wtch w ON w.class_num = i.class_num AND w.inet_num = i.inet_num AND w.id = 'catLove'
    JOIN class c ON c.class_num = i.class_num
WHERE 
    i.class_num = '2'
ORDER BY i.inet_num
</select>

<!-- 수강중인 강의의 인강 비디오(1개 자세히) . classNum, inetNum, id 매개변수 3개 필요 -->

<resultMap id="selectIV" type="java.util.HashMap">
  <result column="inet_num" property="inetNum"/>
  <result column="inet_ttl" property="inetTtl"/>
  <result column="inet_vdo" property="inetVdo"/>
  <result column="inet_desct" property="inetDesct"/>
  <result column="ew_time" property="ewTime"/>
    <result column="class_num" property="classNum"/>
</resultMap>
<select id="selectIV" resultMap="selectIV">
<!-- 시청기록이 없어도 나머지 조건 조합해서 리스트에 뜨도록 수정함 -->
SELECT i.inet_num, i.inet_ttl, i.inet_vdo, i.inet_desct, i.class_num, COALESCE(w.ew_time, '0') as ew_time
FROM inetclass i 
LEFT OUTER JOIN inetclass_wtch w ON i.inet_num = w.inet_num
WHERE i.class_num = '2' AND i.inet_num = #{inetNum} AND (w.id = 'catLove' OR w.id IS NULL)
</select>

<!-- 강의 보는 중에 정보 보내기 -->
<insert id="insertWInfo" parameterType="co.yedam.silhyun.classes.vo.InetClassesWtchVO">
    <selectKey keyProperty="inetwtNum" resultType="int" order="BEFORE">
        select nvl(max(inetwt_num), 0) + 1 from inetclass_wtch
        where inet_num = #{inetNum} and class_num = #{classNum} and id = #{id}
    </selectKey>
    insert into inetclass_wtch (inetwt_num, inet_num, class_num, id, stw_time, ew_time, cumlw_time)
    select #{inetwtNum}, #{inetNum}, #{classNum}, #{id}, #{stwTime}, #{ewTime}, #{cumlwTime}
    from dual
    where not exists (
        select 1 from inetclass_wtch
        where inet_num = #{inetNum} and class_num = #{classNum} and id = #{id}
    )
    union all
    update inetclass_wtch
    set stw_time = #{stwTime}, ew_time = #{ewTime}, cumlw_time = #{cumlwTime}
    where inet_num = #{inetNum} and class_num = #{classNum} and id = #{id}
</insert>
</mapper>