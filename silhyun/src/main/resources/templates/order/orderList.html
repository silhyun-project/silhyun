<!doctype html>
<html lang="zxx" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{home/layout}">

<head>
    <!-- metas -->
    <meta charset="utf-8">
    <meta name="author" content="pxdraft" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="keywords" content="ShopApp - eCommerce Bootstrap 5 Template" />
    <meta name="description" content="ShopApp - eCommerce Bootstrap 5 Template" />
    <!-- title -->
    <title>Í≤∞Ï†úÍπåÏßÄÏôîÎã§Î¶¨</title>
    <script src="https://code.jquery.com/jquery-3.6.3.js"
        integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>
    <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<script>
  
</script>
<body>
    <div layout:fragment="content">
<!--     Î°úÍ∑∏Ïù∏ Ìïú ÏÇ¨Îûå : [[${session.id}]] -->
        <!-- Skippy & Prload -->
        <!-- skippy -->
        <a id="skippy" class="skippy visually-hidden-focusable overflow-hidden" href="#content">
            <div class="container">
                <span class="u-skiplink-text">Skip to main content</span>
            </div>
        </a>
        <!-- End skippy -->
        <!-- Preload -->
        <!-- <div id="loading" class="loading-preloader"> -->
        <!--     <div class="spinner-border text-primary" role="status"> -->
        <!--         <span class="visually-hidden">Loading...</span> -->
        <!--     </div> -->
        <!-- </div> -->
        <!-- End Preload -->
        <!-- Edn Skippy & Prload -->

        <!-- 
    ========================
        Wrapper 
    ========================
    -->
        <div class="wrapper">
            <!-- heder height -->
            <div class="header-height-bar"></div>

            <!-- Main -->
            <main>

                [[${reserVO}]]<br>
                [[${selectedOpVO}]]<br>
                [[${optionsVO}]]<br>
                [[${memInfo}]]/

                <!-- Breadcrumb -->
                <div class="py-3 bg-gray-100">
                    <div class="container">
                        <div class="row align-items-center">
                            <div class="col-lg-6 my-2">
                                <h1 class="m-0 h4 text-center text-lg-start">üòÜÍ≤∞Ï†úÌïòÍ∏∞</h1>
                            </div>
                            <div class="col-lg-6 my-2">
                                <ol
                                    class="breadcrumb dark-link m-0 small justify-content-center justify-content-lg-end">
                                    <li class="breadcrumb-item"><a class="text-nowrap" href="/"><i
                                                class="bi bi-home"></i>Home</a></li>
                                    <li class="breadcrumb-item text-nowrap active" aria-current="page">Í≤∞Ï†ú</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Breadcrumb -->
                <!-- Table -->
                <div class="py-6">
                    <div class="container">
                        <div class="row flex-row-reverse">
                            <!-- sidebar -->
                            <div class="col-lg-5 ps-lg-5">
                                <div class="card">
                                    <div class="card-body">
                                        <ul class="list-unstyled m-0 p-0">
                                            <li class="pb-3 mb-3 border-bottom">
                                                <div class="row align-items-center">
                                                   
                                                    <div class="col-8">
                                                        <!-- Title -->
                                                        <p class="mb-1">
                                                            <a class="text-dark fw-500 opTtl" href="#">[[${optionsVO.ttl}]]</a><br>
                                                            <span class="m-0 text-muted w-100 d-block shotD" >[[${reserVO.shotDate}]]</span>
                                                            <span class="m-0 text-muted w-100 d-block resP">[[${reserVO.resPri}]]</span>
                                                        </p>
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                        <ul class="list-unstyled m-0">
                                            <li class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="me-2 text-body">Ï¥ù ÏÑúÎπÑÏä§ Í∏àÏï°</h6><span
                                                    class="text-end resPri">[[${reserVO.resPri}]]</span>
                                            </li>
                                            <li class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="me-2 text-body">Ïø†Ìè∞ Ìï†Ïù∏</h6><span
                                                    class="text-end cpnPri">-</span>
                                            </li>
                                            <li class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="me-2 text-body">Ìè¨Ïù∏Ìä∏ ÏÇ¨Ïö©</h6><span
                                                    class="text-end pointPri">-</span>
                                            </li>
                                            <li
                                                class="d-flex justify-content-between align-items-center border-top pt-3 mt-3">
                                                <h6 class="me-2">Total</h6><span
                                                    class="text-end text-dark totalM">ÏñºÎßàÏõê</span>
                                            </li>
                                        </ul>
                                        <label class="form-check-label" for="chbox" >
                                            <input type="checkbox" class="form-check-input" id="chbox" name="orderOK">&nbsp;&nbsp;<span class="text-danger">*</span> Ï£ºÎ¨∏ ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏ÌïòÏòÄÏúºÎ©∞, Í≤∞Ï†úÏóê ÎèôÏùòÌï©ÎãàÎã§.(ÌïÑÏàò)</label>
                                        <button style="margin-top: 10px;" type="button" class="btn btn-primary w-100" onclick="requestPay()" disabled>Í≤∞Ï†úÌïòÍ∏∞</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-7" >
                                <div class="card">
                                    <div class="card-header bg-transparent py-3">
                                        <h6 class="m-0 h5">Ïø†Ìè∞ / Ìè¨Ïù∏Ìä∏</h6>
                                    </div>
                                    <div class="card-body" style="padding: 30px;">
                                        <ul class="list-unstyled">
                                            <li class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="me-2 text-body">üéÅÏø†Ìè∞</h6>
                                                <div class="mb-3">
                                                    <select class="form-select dis" name="discount" required="">
                                                        <option value="">ÏÇ¨Ïö©Í∞ÄÎä•Ìïú Ïø†Ìè∞</option>
                                                        <option th:each="mem :${memInfo}" th:text="${mem.cntn}"
                                                        th:value="${mem.discount}" th:selected="${mem.cpnNum}==${reserVO.cpnNum}" th:id="${mem.cpnNum}">
                                                       
                                                    </select>
                                                    <div class="invalid-feedback">Please choose your country!</div>
                                                </div>
                                            </li><li>
                                            <div class="pt-2 pb-3">
                                                <div class="d-flex">
                                                    <input type="text" placeholder="ÏÇ¨Ïö©Ìï† Ìè¨Ïù∏Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                                        class="form-control form-control-sm useP">
                                                    <button type="button" class="btn btn-primary btn-sm ms-2 aapP">Apply</button>
                                                </div>
                                            </div>
                                        </li>
                                            <li class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="me-2 text-body">üí∞ÏÇ¨Ïö©Í∞ÄÎä•Ìïú Ìè¨Ïù∏Ìä∏</h6><span
                                                    class="text-end pointSum">[[${memInfo[0].pointSum}]]Ïõê</span>
                                            </li>

                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="accordion accordion-alt pt-4" id="payment-methods">
                                    <div class="card mb-3 shadow-none border">
                                        <div class="card-header p-0 position-relative bg-transparent">
                                            <div class="form-check m-3" data-bs-toggle="collapse"
                                                data-bs-target="#credit-card">
                                                <input class="form-check-input" type="radio" name="flexRadioDefault"
                                                    id="flexRadioDefault1" checked>
                                                <label class="form-check-label h6 m-0 w-100 stretched-link"
                                                    for="flexRadioDefault1">
                                                    ÌÜµÌï© Í≤∞Ï†ú
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card mb-3 shadow-none border">
                                        <div class="card-header p-0 position-relative bg-transparent">
                                            <div class="form-check m-3" data-bs-toggle="collapse"
                                                data-bs-target="#credit-card">
                                                <input class="form-check-input" type="radio" name="flexRadioDefault"
                                                    id="flexRadioDefault2">
                                                <label class="form-check-label h6 m-0 w-100 stretched-link"
                                                    for="flexRadioDefault2">
                                                    Î¨¥ÌÜµÏû• ÏûÖÍ∏à
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                            
                                </div>
                                <div class="pt-4">
                                    <p class="m-0 pt-3">ÌòÑÍ∏àÏòÅÏàòÏ¶ù(ÏÇ¨ÏóÖÏûêÏßÄÏ∂úÏ¶ùÎπô) / Ïã†Ïö©Ïπ¥Îìú Îß§ÏûÖÏ†ÑÌëúÎäî  Îß§ÏûÖÏÑ∏Ïï°Í≥µÏ†ú ÏÇ¨Ïö©Ïù¥ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§.
                                        [Îß§ÏûÖÏÑ∏Ïï°Í≥µÏ†ú ÏïàÎÇ¥]<br>
                                        ÌòÑÍ∏àÏòÅÏàòÏ¶ù / Ïã†Ïö©Ïπ¥Îìú ÏòÅÏàòÏ¶ùÏùÄ Í∞úÏù∏ ÏÜåÎìù Í≥µÏ†úÏö©ÏúºÎ°úÎßå ÏÇ¨Ïö©ÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.</p>
                                </div>
                            </div>
                        </div>
                        <form>
                            <input type="hidden" name="id" th:value="${reserVO.id}">
                            <input type="hidden" name="shotDate" th:value="${#dates.format(reserVO.shotDate, 'yyyy-MM-dd')}">
                            <input type="hidden" name="ptgId" th:value="${reserVO.ptgId}">
                            <input type="hidden" name="shotTime" th:value="${reserVO.shotTime}">
                            <input type="hidden" name="resPri" th:value="${reserVO.resPri}">
                            <input type="hidden" name="opNum" th:value="${selectedOpVO.opNum}">
                        </form>
                    </div>
                </div>
                <!--Table -->
            </main>
            <!-- End Main -->

        </div>
        <!-- 
    ========================
       End Wrapper 
    ========================
    -->
        <!-- script start -->
        <!-- jquery -->
        <!-- <script src="/js/jquery-3.5.1.min.js"></script> -->
        <!--bootstrap-->
        <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <!-- slick carousel -->
        <script src="/vendor/swiper/swiper-bundle.min.js"></script>
        <!-- magnific -->
        <script src="/vendor/magnific/jquery.magnific-popup.min.js"></script>
        <!-- isotope -->
        <script src="/vendor/isotope/isotope.pkgd.min.js"></script>
        <!-- count-down -->
        <script src="/vendor/count-down/jquery.countdown.min.js"></script>
        <!-- count-down -->
        <script src="/vendor/jarallax/jarallax-all.js"></script>
        <!-- Theme Js -->
        <script src="/js/custom.js"></script>
        <script src="/js/theme.js"></script>
        <!-- End script start -->
        <script>
            let opTtl = $('.text-dark.fw-500.opTtl').text().replace(',','')
                function cutByMaxStr(str, maxLength) {  
                if (str == undefined || str == null) {
                    return '';
                }

                if (str.length > maxLength) {
                    str = str.substring(0, maxLength) + '...'; 
                    // strÏùÑ maxLength Í∏∏Ïù¥ÎßåÌÅº ÏûêÎ•¥Í≥† '.....' ÏùÑ Îí§Ïóê Î∂ôÏù∏Îã§
                }
                return str;
                 }
            let text = cutByMaxStr(opTtl,10)
            console.log(text)
            $('.text-dark.fw-500.opTtl').text(text)
            let shotD = $('.m-0.text-muted.w-100.d-block.shotD').text()
            console.log(shotD)
            // function getFormatDate(date){
            //     var year = date.getFullYear();              //yyyy
            //     var month = (1 + date.getMonth());          //M
            //     month = month >= 10 ? month : '0' + month;  //month ÎëêÏûêÎ¶¨Î°ú Ï†ÄÏû•
            //     var day = date.getDate();                   //d
            //     day = day >= 10 ? day : '0' + day;          //day ÎëêÏûêÎ¶¨Î°ú Ï†ÄÏû•
            //     return  year + '' + month + '' + day;       //'-' Ï∂îÍ∞ÄÌïòÏó¨ yyyy-mm-dd ÌòïÌÉú ÏÉùÏÑ± Í∞ÄÎä•
            // }
            // let test = getFormatDate(shotD)
            // console.log(test)
            
            //ÏÇ¨Ïö©Í∞ÄÎä•Ìïú Ìè¨Ïù∏Ìä∏
            let resp = $('.m-0.text-muted.w-100.d-block.resP').text()
            let resp2=  Number(resp).toLocaleString()
            let totalIng = $('.text-end.text-dark.totalM').text()
              console.log(resp2)
              $('.m-0.text-muted.w-100.d-block.resP').text(resp2+'Ïõê')
              $('.text-end.resPri').text(resp2+'Ïõê')
             
              $('.text-end.text-dark.totalM').text(resp2+'Ïõê')  //Ï¥ùÍ∞ÄÍ≤©
              //Ïø†Ìè∞ Ï†ÅÏö©Ìïú Ìï†Ïù∏ Í∏àÏï°
             let discount = 0;
             $('.form-select').on('change',function(){
                 discount = $(this).val()
                 console.log(discount)
                 let cpnM = (parseInt(resp) * (parseInt(discount) * 0.01))
                 console.log(resp)
                 console.log(resp2)
                 console.log(cpnM)
                
                  $('.text-end.cpnPri').text('-'+Number(cpnM).toLocaleString()+'Ïõê')
                  $('.text-end.text-dark.totalM').text(Number(resp-cpnM).toLocaleString()+'Ïõê')   //TotlaÍ∏àÏï°
                
              })
              //Ìè¨Ïù∏Ìä∏ Ï†ÅÏö©
              $('.aapP').on('click',function(){
                  let useP = $('.useP').val()
                  let SumP = $('.pointSum').text().replace(/[^0-9]/g,'')
                  if(parseInt(SumP) > parseInt(useP)){
                      $('.text-end.pointPri').text('-'+Number(useP).toLocaleString()+'Ïõê')
                      $('.pointSum').text(Number(SumP-useP).toLocaleString()+'Ïõê')  //ÏÇ¨Ïö©Í∞ÄÎä•Ìïú Ìè¨Ïù∏Ìä∏
                      
                      //let realtotal = $('.text-end.text-dark.totalM').text().replace(/[^0-9]/g,'') - Number(useP)
                      let realtotal = $('.text-end.text-dark.totalM').text().replace(/[^0-9]/g,'') - Number(useP)
                      console.log(realtotal)
                      console.log(Number(realtotal).toLocaleString()+'Ïõê')
                      $('.text-end.text-dark.totalM').text(Number(realtotal).toLocaleString()+'Ïõê') //TotlaÍ∏àÏï°

                  }else{
                    alert('ÏÇ¨Ïö©Í∞ÄÎä•Ìïú Ìè¨Ïù∏Ìä∏Î•º Ï¥àÍ≥ºÌïòÏòÄÏäµÎãàÎã§.')
                    console.log($('.useP').val())
                    $('.useP').val('')
                  }
            
              })

            //ÌÜ†ÌÉà Í∏àÏï°
            //let totalPri = resp - cpnM - (SumP-useP)
           // console.log(totalPri)
           let paymPri = Number(0)  //Ï¥ùÍ∏àÏï°
           
           //Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÅ¥Î¶≠Ìï¥ÏïºÏßÄ Í≤∞Ï†úÎ≤ÑÌäº ÌÅ¥Î¶≠ Í∞ÄÎä•
           $(document).ready(function(){
               $("#chbox").change(function(){
                   if($("#chbox").is(":checked")){
                       console.log("Ï≤¥ÌÅ¨Î∞ïÏä§ Ï≤¥ÌÅ¨ÌñàÏùå");
                       $('.btn.btn-primary.w-100').attr("disabled", false)
                       paymPri=  Number($('.text-end.text-dark.totalM').text().replace(/[^0-9]/g,''))
                     
                      // return paymPri
                    }else{
                        console.log("Ï≤¥ÌÅ¨Î∞ïÏä§ Ï≤¥ÌÅ¨ Ìï¥Ï†ú");
                        $('.btn.btn-primary.w-100').attr("disabled", true)
                    }
               
                });
            });

            let list=[];
            //reserÌÖåÏù¥Î∏îÏóê insertÎêòÎäî Îç∞Ïù¥ÌÑ∞
            let id = $('input[name="id"]').val()       
            let shotDate = $('input[name="shotDate"]').val()       
            let ptgId = $('input[name="ptgId"]').val()       
            let shotTime = $('input[name="shotTime"]').val()     
            let uCpNum = $('.dis :selected').attr('id')
            let uPoint = Number($('.useP').val())
            let ordPri = Number($('.text-end.resPri').text().replace(/[^0-9]/g,''))
            //let resPri = paymPri 
            console.log(id,shotDate,ptgId,shotTime,paymPri)   
            console.log(paymPri)  
            console.log(uCpNum)
            console.log(uPoint,ordPri)
            
            //Í≤∞Ï†ú ÌÖåÏù¥Î∏îÏóê insertÎêòÎäî Îç∞Ïù¥ÌÑ∞ 
            let opNum = $('input[name="opNum"]').val()       
            
            
            // obj["id"] = id
            // obj["shotDate"] = shotDate
            // obj["ptgId"] = ptgId
            // obj["shotTime"] = shotTime
            // obj["resPri"] = resPri
           // list.push(obj);
            
            // let obj={
            //     id:id,
            //     shotDate:shotDate,
            //     ptgId:ptgId,
            //     shotTime:shotTime,
            //     resPri:resPri
            // }
        

            let pname = $('.text-dark.fw-500.opTtl').text()  //ÏÉÅÌíà Ïù¥Î¶Ñ   
              //Í≤∞Ï†ú
        const IMP = window.IMP; // ÏÉùÎûµ Í∞ÄÎä•
        IMP.init("imp42851556"); // Ïòà: imp00000000a
            function requestPay() {
                IMP.request_pay({
                pg: 'html5_inicis',  //Ïù¥ÎãàÏãúÏä§ ÏΩîÎìú
                pay_method: "card",   ///Í≤∞Ï†ú ÌåùÏóÖÏ∞Ω ÌòïÌÉú
                merchant_uid: 'merchant_' + new Date().getTime(),   // Ï£ºÎ¨∏Î≤àÌò∏ -> Îß§ÌçºÏóêÏÑú Ï¶ùÍ∞ÄÌïòÎèÑÎ°ù
                name: pname,  //Ï†úÌíàÏù¥Î¶Ñ
                amount: paymPri,                         // Ïà´Ïûê ÌÉÄÏûÖ
                buyer_email: "silhyun@silhyun.kr",
                buyer_name: "Ïã§ÌòÑÌïòÎã§",  //ÌåêÎß§Ïûê Ïù¥Î¶Ñ
                buyer_tel: "1231-1231",  
                buyer_addr: "ÏòàÎã¥ÏßÅÏóÖÏ†ÑÎ¨∏ÌïôÍµê",
                buyer_postcode: "0327"
                }, function (rsp) { // callback
                if (rsp.success) {
                    // Í≤∞Ï†ú ÏÑ±Í≥µ Ïãú Î°úÏßÅ
                    let obj={
                            id:id,
                            shotDate:shotDate,
                            ptgId:ptgId,
                            shotTime:shotTime,
                            resPri:paymPri,
                            ctgrNum:ptgId,
                            uCpNum:uCpNum,
                            uPoint:uPoint,
                            paymPri:paymPri,
                            ordPri:ordPri,
                            imp_uid: rsp.imp_uid
                        }
                        console.log(obj)
                    $.ajax({
                        url: "/pay/reserInsert",
                        method: "post",
                        headers: { "Content-Type": "application/json" },
                        data:JSON.stringify(obj)
                        
                       //Í≥†Ïú†ID
                    //    merchant_uid: rsp.merchant_uid   
                    }).then((data) => {
                        // ÏÑúÎ≤Ñ Í≤∞Ï†ú API ÏÑ±Í≥µÏãú Î°úÏßÅ
                        console.log('Í≤∞Ï†úÏôÑ')
                        alert("Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Í≤∞Ï†úÎêòÏóàÏäµÎãàÎã§.")
                        location.href = "/pay/orderEnd"
                    })
                } else {
                    // Í≤∞Ï†ú Ïã§Ìå® Ïãú Î°úÏßÅ
                    alert(`Í≤∞Ï†úÏóê Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§. ÏóêÎü¨ ÎÇ¥Ïö©: ${rsp.error_msg}`);
                }

                });
            }
            
            
        </script>
    </div>
</body>

</html>