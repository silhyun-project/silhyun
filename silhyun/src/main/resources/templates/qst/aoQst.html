<!doctype html>
<html lang="zxx" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{home/layout}">
<style>

#btn1{
  float:right;
  display: inline;
  width: 100px;
  height:30px;
}

ul {
  overflow: hidden; /* float 요소를 감싸는 부모 요소의 높이 자동 조절 */
}
li {
  float: left;
}

</style>

<head>
<!-- metas -->
<meta charset="utf-8">
<meta name="author" content="pxdraft" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="keywords" content="ShopApp - eCommerce Bootstrap 5 Template" />
<meta name="description"
	content="ShopApp - eCommerce Bootstrap 5 Template" />
<!-- title -->
<title>작가 문의게시판</title>
<!-- Favicon -->
<link rel="shortcut icon" href="/img/favicon.ico">
<!-- CSS Template -->
<link href="/css/theme.css" rel="stylesheet">
</head>

<body>
<div layout:fragment="content">

	<div class="pt-4 mt-5"> 
	<!-- 댓글 대댓글 들어가는 곳 -->		
	<ul class="list-unstyled pt-4 qstBox" id="attch">	
	</ul>
	</div>
	<div class="mt-8 border p-4">
		<form method="post">
			<div class="row">
				<div class="col-12">
					<div class="form-group mb-3">
						<textarea id="ttl" name="ttl" placeholder="제목을 작성해주세요" required="required"></textarea>							
						<textarea class="form-control" id="contact-message" name="message"
							style="height: 50px" placeholder="내용을 작성해주세요"></textarea>
						<label><input type="checkbox" id="secChk" class="secChk" value="Y">비밀문의</label>
					</div>
				</div>
				<div class="col-12">
					<button class="btn btn-primary" type="button" id="send">게시</button>
				</div>
			</div>
		</form>
	</div>

	<!-- End Main -->

	<!-- End Footer -->
	<!-- 
    ========================
       End Wrapper 
    ========================
    -->
	<!-- script start -->
	<!-- jquery -->
	<script src="/js/jquery-3.5.1.min.js"></script>
	<!--bootstrap-->
	<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<!-- slick carousel -->
	<script src="/vendor/swiper/swiper-bundle.min.js"></script>
	<!-- magnific -->
	<script src="/vendor/magnific/jquery.magnific-popup.min.js"></script>
	<!-- isotope -->
	<script src="/vendor/isotope/isotope.pkgd.min.js"></script>
	<!-- count-down -->
	<script src="/vendor/count-down/jquery.countdown.min.js"></script>
	<!-- count-down -->
	<script src="/vendor/jarallax/jarallax-all.js"></script>
	<!-- Theme Js -->
	<script src="/js/custom.js"></script>
	<script src="/js/theme.js"></script>
	<!-- End script start -->
	
	<script>
	$(document).ready(function(){
		getAoQstList()
	})
	
	$("#qstBtn").click(function(){ //문의글 등록
		let qstNum = $("#qstNum").val(); //문의글번호
		let ctgr = 'A' //카테고리
		let ctgrNum = 'user1' //카테고리
		let ttl = $("#ttl").val(); // 제목
		let qstId =$("#id").val(); //문의작성자아이디
		let qstCntn =$("#qstCntn").val(); //문의내용
		let rplySta = 'N' // 답변유무상태
		let secretSta = $("#secChk").val() //비밀댓글

		if ($("#secChk").is(':checked')) {
			comLock = 'Y';
			} else {
			comLock = 'N';
		}
		if(ttl == ""){
			alert("제목을 입력해 주세요.")
			$("#ttl").focus();
			return false;		// 제목 미입력시 작성 불가
		}

		if(qstCntn == ""){
			alert("내용을 입력해 주세요.")
			$("#qstCntn").focus();
			return false;		// 내용 미입력시 작성 불가
		}
		
		$.ajax({
			url:"/aoQstInsert",
			type:"POST",
			data: JSON.stringify(
				{
					"qstNum" : qstNum, // 문의글 번호
					"ctgr" : ctgr,
					"ctgrNum" : ctgrNum,
					"ttl" : ttl, // 제목
					"id" : qstId, //작성자아이디
					"qstCntn" : qstCntn,
					"rplySta" : rplySta, // 답글여부
					"secretSta" : secretSta// 비밀여부
				}
			),
			contentType:'application/json',
			success : function(data){
				console.log("댓글등록")
				$("#comContent").val("")
				console.log("====")
				getComList()
			},
			error:function(){
				alert('등록실패');
			}
		});
	});
	
	
	function getAoQstList(){			

		let qstArea = $(".qstBox");
		$.ajax({
			url: "/getAoQstList",
			success : function(result) {
				let str = '';
				
				$(result).each(function(q,aqst){
					if(comm.dep == 0 && c != 0 ){
					 	str += '</ul>'
		                str += '</li>'
					}
					
						str += '<li class="media d-flex commentZone">'
						str += '<div class="avatar rounded-circle">'
						str += '<img class="img-fluid" src="'+aqst.profile+'" title="" alt="">'
						str += '</div>'
						str += '<h6 class="mt-0 mb-1 commentId" id="qstId" >'+aqst.id+'</h6>'
						str += '<label class="mb-2 small" >'+aqst.qstDate+'</label>'
						str += '<p>'+comm.cntn+'</p>'
						str += '<input type="hidden" class="comGrp" name="ctgrNum" id="ctgrNum" value="'+asqt.ctgrNum+'">'
						str += '<input type="hidden" class="comNum" name="comNum" value="'+asqt.qstNum+'">'
						str += '<div class="nav dark-link small">'
						str += '<a class="ms-3" href="#contact-message" id="replyWrite"> 답글 달기 </a>'
						str += '<button class="comDelBtn" style="border:none; background-color: white;">삭제</button>'	
						str += '</div>'
					
					
						str += '<ul class="list-unstyled mt-5 pt-5 border-top">'
						str += '<li class="media d-flex replyZone">'
                        str += '<div class="col ps-3">'
                        str += '<h6 class="mt-0 mb-1 commentId" id="repId">'+aqst.cntnNum+'</h6>'
                        str += '<label class="mb-2 small">'+comm.comDate+'</label>'
                        str += '<p>'+aqst.cntn+'</p>'
                        str += '<input type="hidden" class="repGrp" name="grp" id="repGrp" value="'+comm.grp+'">'
						str += '<input type="hidden" class="comNum" name="comNum" value="'+comm.comNum+'">'
                        str += '<div class="nav dark-link small">'
                        str += '<a class="ms-3" href="#contact-message" id="rereplyWrite">답글 달기</a>'
                        str += '<button class="reDelBtn" style="border:none; background-color: white;">삭제</button>'
                        str += '</div>'
                        str += '</div>'
                        str += '</li>'  
					
				})
					commentArea.html(str);
			}
		})
	}
	
	// 동적으로 생성된 태그에 그룹이벤트 부여
    $(".qstBox").on('click','#replyWrite', function(e){      
        console.log('클릭')
        console.log($(this).parent().parent().children('#comId').text())// 그룹번호 히든으로 만들어서 그룹번호가져옴
        console.log($(this).parent().parent().children('#ctgrNum').val())
        let text = $(this).parent().parent().children('#qstId').text();
        let group_number = $(this).parent().parent().children('#ctgrNum').val();
        
        $('#contact-message').val('Re:'+$(this).parent().parent().children('#ttl').text())  
        $('#contact-message').data("dep","1")
        $('#contact-message').data("grp", group_number);
        $('#grpNum').val($('#contact-message').data("grp"));
 
     })  
     
	
 	$(".qstBox").on('click', '.comDelBtn', function() {
 		console.log('삭제클릭')
 		console.log($(this).closest('li').find('.comNum').val());
 		console.log($(this).closest('li').find('.comGrp').val());
 		let comNum = $(this).closest('li').find('.qstNum').val(); //삭제할 댓글 번호
 		let grp = $(this).closest('li').find('.comGrp').val(); //삭제할 댓글의 그룹
 		let commentZone = $(this).closest('li').find('.commentZone');
 		
 		$.ajax({
			url:"/commentDelete",
			type:"delete",
			data:{ 
				grp		
			}
			,
			success : function(data){
				getAoQstList()
			}
		})
 		
 	}) 
 	
 	$(".qstBox").on('click', '.reDelBtn', function() {
 		console.log('삭제클릭')
 		console.log($(this).closest('li').find('.comNum').val());
 		let comNum = $(this).closest('li').find('.comNum').val(); //삭제할 댓글 번호
 		let commentZone = $(this).closest('li').find('.replyZone');
 		
 		$.ajax({
			url:"/replyDelete",
			type:"delete",
			data:{ 
				comNum		
			}
			,
			success : function(data){
				getAoQstList()
			}
		})
 	}) 
	
</script>
</div>
</body>
</html>